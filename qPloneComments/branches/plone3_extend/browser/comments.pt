<tal:block define="userHasReplyPermission view/can_reply;
                   isDiscussionAllowed view/is_discussion_allowed;
                   replies view/get_replies;
                   isAnon view/is_anonymous;
                   ifModerate view/is_moderation_enabled;
                   isModerationAllowed view/can_moderate;
                   foo context/@@plone/globalize;
	           props_sheet here/portal_properties/qPloneComments;
                   require_email python:props_sheet.getProperty('require_email');
                   isForAnonymous python:props_sheet.getProperty('enable_anonymous_commenting', 0);"
                   i18n:domain="plone">
    <div class="discussion"
         tal:condition="python:replies or (userHasReplyPermission and isDiscussionAllowed) or (isAnon and not userHasReplyPermission and isDiscussionAllowed)">

        <tal:getreplies repeat="reply_dict replies">
            <div class="comment" style=""
                tal:condition="python:isModerationAllowed or isPublished"
                tal:define="indent python:reply_dict['depth']*2;
                            reply python:reply_dict['object'];
                            isPublished python:reply.review_state=='published';"
                tal:attributes="style string:margin-left:${indent}em;">

                <h3>
                    <a name="comments" tal:attributes="name reply/id">
                    <span tal:replace="reply/pretty_title_or_id">Comment title</span>
                    </a>
                </h3>
                <div class="documentByLine"
                     tal:define="creator reply/Creator;
                                 anonymous_creator python:creator=='Anonymous User';
                                 mi python:not anonymous_creator and view.member_info(creator);
                                 fullname python: mi and mi['fullname'] or creator;
                                 gavatar_src python:view.getGravatar(reply)" >
                    <img alt="Avatar" class="avatar" height="40" width="40"
                         src="http://default.gavatar.gif"
                         tal:attributes="src gavatar_src">
                    <span i18n:translate="label_comment_by">Posted by</span>
                    <span tal:content="fullname"
                          tal:condition="not:anonymous_creator">Poster Name</span>
                    <span i18n:translate="label_anonymous_user"
                          tal:condition="anonymous_creator">Anonymous User</span>
                    <span i18n:translate="label_commented_at">at</span>
                    <span tal:replace="python:view.format_time(reply.ModificationDate())">8/23/2001 12:40:44 PM</span>
                    <span tal:condition="python:ifModerate and not isPublished">[pending]</span>
                </div>
                <div class="commentBody"
                     tal:content="structure reply/CookedBody">
                     This is the body text of the comment.
                </div>
                <form name="reply"
                      action="discussion_reply_form"
                      method="post"
                      style="display: inline;"
                      tal:attributes="action string:${reply/absolute_url}/discussion_reply_form"
                      tal:condition="python:userHasReplyPermission and isPublished">
                    <input class="standalone"
                           type="submit"
                           value="Reply"
                           i18n:attributes="value label_reply;"
                           />
                </form>
                <form name="delete"
                      action=""
                      method="post"
                      style="display: inline;"
                      tal:condition="isModerationAllowed"
                      tal:attributes="action string:${reply/absolute_url}/deleteDiscussion">
                    <input class="destructive"
                           type="submit"
                           value="Remove"
                           i18n:attributes="value label_remove;"
                           />
                </form>
                <form name="publish_discussion"
                      action=""
                      method="post"
                      style="display: inline;"
                      tal:condition="not:isPublished"
                      tal:attributes="action string:${reply/absolute_url}/discussion_publish_comment">

                    <input class="standalone"
                           type="submit"
                           value="Publish"
                           i18n:attributes="value"
                           />
                </form>
                <br/>
                <div class="documentByLine"
                     i18n:translate="text_no_add_reply"
                     i18n:domain="plonecomments"
                     tal:condition="not:isPublished">Comment must be approved before replies to comment accepted.</div>


            </div>
        </tal:getreplies>

        <!-- Start of Adding comment form-->

	<form name="edit_form"
	      class="enableAutoFocus"
	      method="post"
	      action="talkback"
	      tal:attributes="action string:$here_url/discussion_reply_form"
>

	    <fieldset>

		<legend i18n:translate="legend_add_comment">Add comment</legend>

		<p i18n:translate="description_add_comment">
		    You can add a comment by filling out the form below. Plain text
		    formatting.
		</p>

		<input type="hidden" name="Creator" value=""
		       tal:attributes="value member/getUserName"
		       tal:condition="not:isForAnonymous"/>

		<div tal:condition="isForAnonymous">

		    <input type="hidden"
			   name="Creator"
			   tal:condition="not:isAnon"
			   tal:attributes="value member/getUserName" />

		     <div class="field"
			 tal:condition="isAnon"
			 tal:define="error errors/Creator|nothing;"
			 tal:attributes="class python:error and 'field error' or 'field';">

			<label for="username" i18n:translate="label_name">Name</label>

			<span class="fieldRequired" title="Required"
			      tal:condition="isAnon"
			      i18n:attributes="title"
			      i18n:translate="label_required">(Required)</span>

			<div class="formHelp" i18n:translate="help_name"
			     i18n:domain="plonecomments">
			    Tell us your name.
			</div>

			<div tal:content="error">Validation error output</div>

			<div>
			    <input name="Creator"
				   id="username"
				   value="" alt="Submitter" title="Name"
				   size="40"
				   i18n:attributes="alt; title"
				   tal:attributes="value request/Creator | nothing" />
			</div>

		    </div>

		    <div class="field"
			 tal:define="error errors/email|nothing;"
			 tal:attributes="class python:error and 'field error' or 'field'"
			 tal:condition="python:require_email and isAnon">

			<label for="email" i18n:translate="label_email">E-Mail</label>

			<span class="fieldRequired" title="Required"
			      i18n:attributes="title title_required;"
			      i18n:translate="label_required">(Required)
			</span>

			<div class="formHelp" i18n:translate="help_email"
			     i18n:domain="plonecomments">
			    Enter your e-mail address.
			</div>

			<div tal:content="error">Validation error output</div>

			<input name="email" value="" size="40" />

		    </div>

		</div>

		<div tal:condition="python:(not isForAnonymous) and isAnon">
		    <dl class="portalMessage warning">
			<dt i18n:translate="">
			    Info
			</dt>
			<dd i18n:translate="legend_note_reply_anonymous">
			    You are not logged in. You may optionally enter your
			    username and password below. If you don't enter anything,
			    this comment will be posted as 'Anonymous User'.
			</dd>
		    </dl>

		    <div class="field">

			<label for="username" i18n:translate="label_name">Name</label>

			<input name="username"
			       id="username"
			       value="" alt="Username" title="Name"
			       size="40"
			       i18n:attributes="title label_name; alt label_username;" />

		    </div>

		    <div class="field">

			<label for="password" i18n:translate="label_password">Password</label>

			<input type="password"
			       id="password"
			       name="password"
			       value="" alt="Password" title="Password"
			       size="40"
			       i18n:attributes="title label_password; alt label_password;" />

		    </div>
	    </div>

	    <div class="field"
	    tal:define="error errors/subject|nothing;"
	    tal:attributes="class python:error and 'field error' or 'field'">

		    <label for="subject" i18n:translate="label_subject">Subject</label>

	    <span class="fieldRequired" title="Required"
		  i18n:attributes="title title_required;"
		  i18n:translate="label_required">(Required)</span>

		<div tal:content="error">Validation error output</div>

		    <input name="subject"
			   id="subject"
			   value=""
			   size="40"
			   tal:attributes="value request/subject|request/title_override|nothing;" />

		</div>

	    <div class="field"
	    tal:define="error errors/body_text|nothing;"
	    tal:attributes="class python:error and 'field error' or 'field'">

	      <label for="body_text" i18n:translate="label_comment">Comment</label>

	    <span class="fieldRequired" title="Required"
		  i18n:attributes="title title_required;"
		  i18n:translate="label_required">(Required)</span>

		<div tal:content="error">Validation error output</div>

		    <textarea name="body_text"
			      id="body_text"
			      cols="40"
			      rows="8"
			      tal:content="request/body_text|request/text_override | nothing"
			    ></textarea>

		</div>

		 <p class="formHelp" tal:condition="python:require_email and isAnon">
		    Want to add a picture to your comments here on 
		    <tal:site content="portal_title|default">the Site</tal:site>? <br />
		    Upload a picture at <a href="http://en.gravatar.com">Gravatar</a> to make it happen.
		 </p>

		 <div tal:condition="nocall:here/captcha_widget|nothing"
		      tal:omit-tag="">
		    <div metal:use-macro="here/captcha_widget/macros/captcha" />
		 </div>

		<div class="formControls">

		    <input type="hidden" name="form.submitted" value="1" />

		    <input type="hidden" name="require_email:boolean" value=""
			   tal:attributes="value python:require_email and isAnon" />

		    <input class="context"
			   type="submit"
			   value="Save"
			   name="form.button.Save"
			   i18n:attributes="value label_save;"
			   tal:attributes="name string:discussion_reply:method;" />

		</div>

	    </fieldset>

	</form>

        <!-- End of Adding comment form -->

        <form tal:condition="python:isAnon and not userHasReplyPermission and isDiscussionAllowed"
              tal:attributes="action view/login_action">
            <input class="standalone"
                   style="margin-bottom: 1.25em;"
                   type="submit"
                   value="Log in to add comments"
                   i18n:attributes="value label_login_to_add_comments;"
                   />
        </form>

    </div>
</tal:block>
